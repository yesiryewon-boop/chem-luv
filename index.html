<!DOCTYPE html><html lang="ko"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>ì¤‘í™”ë°˜ì‘ ì´ ì´ì˜¨ìˆ˜ ì‹œë®¬ë ˆì´í„°</title>    <!-- Firebase ëª¨ë“ˆ ì„í¬íŠ¸ ë° ì „ì—­í™” -->    <script type="module">        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";        // ì „ì—­ ìŠ¤ì½”í”„ì— Firebase í•¨ìˆ˜ í• ë‹¹        window.initializeApp = initializeApp;        window.getAuth = getAuth;        window.signInAnonymously = signInAnonymously;        window.signInWithCustomToken = signInWithCustomToken;        window.getFirestore = getFirestore;        window.collection = collection;        window.addDoc = addDoc;        window.onSnapshot = onSnapshot;        window.query = query;        window.serverTimestamp = serverTimestamp;        window.setLogLevel = setLogLevel;    </script>    <script src="https://cdn.tailwindcss.com"></script>    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">    <style>        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }        .card { transition: all 0.2s ease-in-out; }        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }        input[type="number"]::-webkit-inner-spin-button,         input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }        input[type="number"] { -moz-appearance: textfield; }        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ë§ */        #ionCountCanvas, #analysisCanvas { border: 1px solid #e0e7ff; background-color: #ffffff; border-radius: 0.75rem; }    </style></head><body class="p-4 md:p-8">    <div class="max-w-6xl mx-auto">        <header class="mb-8">            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-2">ì¤‘í™”ë°˜ì‘ ì´ ì´ì˜¨ ìˆ˜ í•™ìŠµ ì‹œë®¬ë ˆì´í„°</h1>            <p class="text-gray-600">ì‚°ê³¼ ì—¼ê¸°ì˜ ê°€ìˆ˜(ì›ìê°€), ë†ë„, ë¶€í”¼ì— ë”°ë¥¸ ì¤‘í™”ë°˜ì‘ ì‹œ ì´ ì´ì˜¨ ìˆ˜ ë³€í™”ë¥¼ ê·¸ë˜í”„ë¡œ í™•ì¸í•˜ê³ , í•™ìŠµ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>        </header>        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">            <!-- ì„¤ì • íŒ¨ë„ -->            <div class="lg:col-span-1 space-y-6">                                <!-- 1. ì¡°í•© ì„ íƒ -->                <div class="card bg-white p-5 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-3">1. ì‚°/ì—¼ê¸° ê°€ìˆ˜ ì¡°í•© ì„ íƒ</h2>                    <div id="combinationSelectors" class="grid grid-cols-2 gap-3 text-sm">                        <!-- ì¡°í•© ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— JSë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->                    </div>                </div>                <!-- 2. ì´ˆê¸° ì¡°ê±´ ì…ë ¥ (ì‚°) -->                <div class="card bg-white p-5 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-3">2. í”Œë¼ìŠ¤í¬ ë‚´ ì‚° (Acid) ì¡°ê±´</h2>                    <div class="space-y-3">                        <div>                            <label class="block text-gray-700 font-medium mb-1">ë†ë„ (<span id="acidValDisplay">HA</span>)</label>                            <!-- ë†ë„ ì œí•œ: 0.1 ~ 0.3 -->                            <input type="number" id="molarityAcid" value="0.1" step="0.01" min="0.1" max="0.3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">                            <span class="text-xs text-gray-500">M (ëª° ë†ë„, 0.1~0.3 ë²”ìœ„)</span>                        </div>                        <div>                            <label class="block text-gray-700 font-medium mb-1">ë¶€í”¼ (<span id="acidValDisplayV">VA</span>)</label>                            <input type="number" id="volumeAcid" value="10" step="1" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">                            <span class="text-xs text-gray-500">mL (ì´ˆê¸° ë¶€í”¼)</span>                        </div>                    </div>                </div>                <!-- 3. ì ì •ì•¡ ì¡°ê±´ ì…ë ¥ (ì—¼ê¸°) -->                <div class="card bg-white p-5 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-3">3. ì ì •ì•¡ ì—¼ê¸° (Base) ì¡°ê±´</h2>                    <div class="space-y-3">                        <div>                            <label class="block text-gray-700 font-medium mb-1">ë†ë„ (<span id="baseValDisplay">BOH</span>)</label>                              <!-- ë†ë„ ì œí•œ: 0.1 ~ 0.3 -->                            <input type="number" id="molarityBase" value="0.1" step="0.01" min="0.1" max="0.3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">                            <span class="text-xs text-gray-500">M (ëª° ë†ë„, 0.1~0.3 ë²”ìœ„)</span>                        </div>                        <div>                            <label class="block text-gray-700 font-medium mb-1">ìµœëŒ€ ì ì • ë¶€í”¼ (V_max, ìµœì†Œê°’)</label>                            <input type="number" id="maxVolumeBase" value="30" step="1" min="10" max="100" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">                            <span class="text-xs text-gray-500">mL (V_eqê°€ ì´ ê°’ë³´ë‹¤ í¬ë©´ ê·¸ë˜í”„ ìµœëŒ€ê°’ì´ ìë™ìœ¼ë¡œ ì¡°ì •ë¨)</span>                        </div>                    </div>                </div>                <!-- 4. ì‚¬ìš©ì í›„ê¸° ë° ë¶„ì„ (NEW) -->                <div class="card bg-white p-5 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-3">4. í•™ìŠµ í›„ê¸° ë‚¨ê¸°ê¸°</h2>                    <div class="flex justify-center mb-3 space-x-1" id="starRating">                        <!-- Star icons will be injected by JS -->                    </div>                    <button id="submitRatingBtn" class="w-full p-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>                        ë³„ì  ì œì¶œ                    </button>                    <p id="ratingMessage" class="text-center text-sm mt-2 text-gray-500 h-4"></p>                </div>            </div>            <!-- ê·¸ë˜í”„ ë° ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->            <div class="lg:col-span-2 space-y-6">                <div class="card bg-white p-6 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-4">5. ì´ ì´ì˜¨ ìˆ˜ ë³€í™” ê·¸ë˜í”„ (Base ì²¨ê°€ëŸ‰ì— ë”°ë¥¸)</h2>                    <p class="text-sm text-gray-500 mb-2">ğŸ’¡ ê·¸ë˜í”„ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ íœ ì„ ìŠ¤í¬ë¡¤í•˜ë©´ Xì¶• ë²”ìœ„(ìµœëŒ€ ë¶€í”¼)ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>                    <canvas id="ionCountCanvas" class="w-full aspect-[4/3]"></canvas>                    <div id="resultsSummary" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">                        <!-- ê²°ê³¼ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->                    </div>                </div>                <!-- í›„ê¸° ë¶„ì„ ê·¸ë˜í”„ (NEW) -->                <div class="card bg-white p-6 rounded-xl shadow-lg">                    <h2 class="text-xl font-bold text-gray-800 mb-4">6. ì‚¬ìš©ì í›„ê¸° ë¶„ì„ (ì „ì²´ ì‚¬ìš©ì)</h2>                    <canvas id="analysisCanvas" class="w-full aspect-[2/1]"></canvas>                </div>            </div>        </div>    </div>    <script>        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •        let currentAcidValence = 1; // 1ê°€ ì‚°        let currentBaseValence = 1; // 1ê°€ ì—¼ê¸°        let selectedRating = 0;        let isAuthReady = false;         let db, auth, userId;        let ratings = []; // Array to store fetched ratings                const combinations = [            { acidVal: 1, baseVal: 1, name: "1ê°€ ì‚° + 1ê°€ ì—¼ê¸°" },            { acidVal: 1, baseVal: 2, name: "1ê°€ ì‚° + 2ê°€ ì—¼ê¸°" },            { acidVal: 2, baseVal: 1, name: "2ê°€ ì‚° + 1ê°€ ì—¼ê¸°" },            { acidVal: 2, baseVal: 2, name: "2ê°€ ì‚° + 2ê°€ ì—¼ê¸°" },        ];        // --- DOM ìš”ì†Œ ì ‘ê·¼ ---        const acidValDisplay = document.getElementById('acidValDisplay');        const baseValDisplay = document.getElementById('baseValDisplay');        const ionCountCanvas = document.getElementById('ionCountCanvas');        const ctx = ionCountCanvas.getContext('2d');        const combinationSelectors = document.getElementById('combinationSelectors');        const resultsSummary = document.getElementById('resultsSummary');                const starRatingContainer = document.getElementById('starRating');        const submitRatingBtn = document.getElementById('submitRatingBtn');        const ratingMessage = document.getElementById('ratingMessage');        const analysisCanvas = document.getElementById('analysisCanvas');        const actx = analysisCanvas.getContext('2d');                const inputs = [            document.getElementById('molarityAcid'),            document.getElementById('volumeAcid'),            document.getElementById('molarityBase'),            document.getElementById('maxVolumeBase'),        ];        // --- ìµœëŒ€ ê³µì•½ìˆ˜ (GCD) í•¨ìˆ˜ ---        function gcd(a, b) {            while (b) {                [a, b] = [b, a % b];            }            return a;        }        // --- í•µì‹¬ ê³„ì‚° í•¨ìˆ˜: ì´ ì´ì˜¨ ìˆ˜ (ëª° ë‹¨ìœ„ ìƒëŒ€ê°’) ---        function calculateTotalIons(MA, VA, MB, VB_added, acidVal, baseVal) {            // ëª¨ë“  ë¶€í”¼ëŠ” mL ë‹¨ìœ„ë¡œ ê°€ì •í•˜ê³  ê³„ì‚°í•©ë‹ˆë‹¤. ëª°ìˆ˜ ìƒëŒ€ê°’ìœ¼ë¡œ ì·¨ê¸‰í•©ë‹ˆë‹¤.            const nH_initial = MA * VA * acidVal;            const nOH_added = MB * VB_added * baseVal;            // êµ¬ê²½ê¾¼ ì´ì˜¨ ëª° ë†ë„ ìƒë‹¹ëŸ‰ (M*V): ì‚°ì˜ ìŒì´ì˜¨ + ì—¼ê¸°ì˜ ì–‘ì´ì˜¨            const nAnion = MA * VA; // ì‚°ì˜ ìŒì´ì˜¨ ëª°ìˆ˜            const nCation = MB * VB_added; // ì—¼ê¸°ì˜ ì–‘ì´ì˜¨ ëª°ìˆ˜            let nTotalRelative;            if (nH_initial >= nOH_added) {                // ì‚°ì„± ë˜ëŠ” ì¤‘í™”ì  (H+ ì´ˆê³¼ ë˜ëŠ” ë™ì¼)                // ì´ ì´ì˜¨ ìˆ˜ = êµ¬ê²½ê¾¼ ì´ì˜¨(nAnion + nCation) + ë‚¨ì€ H+                const nH_excess = nH_initial - nOH_added;                nTotalRelative = nAnion + nCation + nH_excess;            } else {                // ì—¼ê¸°ì„± (OH- ì´ˆê³¼)                // ì´ ì´ì˜¨ ìˆ˜ = êµ¬ê²½ê¾¼ ì´ì˜¨(nAnion + nCation) + ë‚¨ì€ OH-                const nOH_excess = nOH_added - nH_initial;                nTotalRelative = nAnion + nCation + nOH_excess;            }            return nTotalRelative;        }        // --- ê·¸ë˜í”„ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì¤‘í™”ë°˜ì‘) ---        function drawGraph() {            const MA = parseFloat(inputs[0].value);            const VA = parseFloat(inputs[1].value); // mL            const MB = parseFloat(inputs[2].value);            const VMaxUser = parseFloat(inputs[3].value); // User's input for VMax            // ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬ (0.1 <= Molarity <= 0.3)            if (isNaN(MA) || MA < 0.1 || MA > 0.3 || isNaN(VA) || VA <= 0 || isNaN(MB) || MB < 0.1 || MB > 0.3 || isNaN(VMaxUser) || VMaxUser < 10) {                ctx.clearRect(0, 0, ionCountCanvas.width, ionCountCanvas.height);                resultsSummary.innerHTML = `<p class="text-red-600 font-semibold">ê²½ê³ : ë†ë„ëŠ” 0.1~0.3 M, ë¶€í”¼ëŠ” ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ìµœëŒ€ ë¶€í”¼ëŠ” 10mL ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</p>`;                return;            }            // ë“±ê°€ì  ë¶€í”¼ ê³„ì‚° (mL)            const V_eq = (MA * VA * currentAcidValence) / (MB * currentBaseValence);            // --- ê·¸ë˜í”„ ìµœëŒ€ ë¶€í”¼ (VMaxGraph) ë™ì  ì„¤ì • ---            let VMaxGraph = VMaxUser;            // ì¤‘í™”ì ì´ ì‚¬ìš©ì ì…ë ¥ VMaxë³´ë‹¤ í¬ë©´, Veqë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë˜í”„ ìµœëŒ€ê°’ì„ ì„¤ì •í•˜ì—¬ ì¤‘í™”ì  ì´í›„ë¥¼ í¬í•¨ì‹œí‚´            if (V_eq > VMaxUser) {                // Veqì˜ 120%ë¥¼ VMaxGraphë¡œ ì„¤ì • (ìµœì†Œ Veq + 20% ë§ˆì§„)                VMaxGraph = V_eq * 1.2;                // VMaxGraphê°€ ë„ˆë¬´ ì‘ì§€ ì•Šë„ë¡ ìµœì†Œ 10mLëŠ” ìœ ì§€                if (VMaxGraph < 10) VMaxGraph = 10;             } else {                 // VMaxUserë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, V_eqê°€ VMaxUserì˜ 10%ë³´ë‹¤ ì‘ìœ¼ë©´ V_eq ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€                if (V_eq < VMaxUser * 0.1 && V_eq > 0) {                    VMaxGraph = V_eq * 5; // ì¤‘í™”ì  ë¶€ê·¼ì„ í™•ëŒ€í•˜ì—¬ ë³´ì—¬ì¤Œ                }            }            // ìµœì¢… VMaxGraphëŠ” ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼í•˜ì—¬ ê¹”ë”í•˜ê²Œ í‘œì‹œ            VMaxGraph = parseFloat(VMaxGraph.toFixed(2));            // --- END NEW ---            // ë°ì´í„° í¬ì¸íŠ¸ ìƒì„±            const dataPoints = [];            const steps = 100; // ê·¸ë˜í”„ í•´ìƒë„            let maxYValue = 0;            for (let i = 0; i <= steps; i++) {                const VB_added = (i / steps) * VMaxGraph; // Use VMaxGraph for iteration                const N_total = calculateTotalIons(MA, VA, MB, VB_added, currentAcidValence, currentBaseValence);                dataPoints.push({ x: VB_added, y: N_total });                if (N_total > maxYValue) maxYValue = N_total;            }            // --- ìº”ë²„ìŠ¤ ì„¤ì • ---            const W = ionCountCanvas.width;            const H = ionCountCanvas.height;            const padding = 50;            ctx.clearRect(0, 0, W, H);            // ìŠ¤ì¼€ì¼ ì„¤ì •            const xScale = (W - 2 * padding) / VMaxGraph; // Use VMaxGraph for scaling            const yScale = (H - 2 * padding) / maxYValue;            // X, Yì¶• ê·¸ë¦¬ê¸°            ctx.beginPath();            ctx.strokeStyle = '#374151';            ctx.lineWidth = 2;            ctx.moveTo(padding, padding);            ctx.lineTo(padding, H - padding); // Yì¶•            ctx.lineTo(W - padding, H - padding); // Xì¶•            ctx.stroke();            // ë¼ë²¨ ë° ëˆˆê¸ˆ            ctx.font = '14px Inter';            ctx.fillStyle = '#4b5563';            ctx.textAlign = 'center';            // Xì¶• ë¼ë²¨            ctx.fillText('ì—¼ê¸° ì²¨ê°€ ë¶€í”¼ (mL)', W / 2, H - 10);            ctx.textAlign = 'right';            ctx.fillText('0', padding - 5, H - padding + 5);            ctx.textAlign = 'left';            // Use VMaxGraph for axis label            ctx.fillText(`${VMaxGraph.toFixed(2)}`, W - padding - 10, H - padding + 5);                         // Yì¶• ë¼ë²¨            ctx.save();            ctx.translate(20, H / 2);            ctx.rotate(-Math.PI / 2);            ctx.fillText('ì´ ì´ì˜¨ ìˆ˜ (ìƒëŒ€ ëª°ìˆ˜)', 0, 0);            ctx.restore();            ctx.textAlign = 'right';            ctx.fillText('0', padding - 5, H - padding + 5); // 0,0 ì›ì             // ë“±ê°€ì  í‘œì‹œ (V_eqê°€ VMaxGraph ë²”ìœ„ ë‚´ì— ìˆì„ ê²½ìš°)            if (V_eq >= 0 && V_eq <= VMaxGraph) {                const eqX = padding + V_eq * xScale;                ctx.strokeStyle = '#ef4444'; // ë¹¨ê°„ìƒ‰                ctx.setLineDash([5, 5]); // ì ì„                                 // ë“±ê°€ì  Xì¶• ë¼ì¸                ctx.beginPath();                ctx.moveTo(eqX, H - padding);                ctx.lineTo(eqX, padding);                ctx.stroke();                                ctx.setLineDash([]); // ì ì„  í•´ì œ                ctx.fillStyle = '#ef4444';                ctx.textAlign = 'left';                ctx.fillText(`V_eq: ${V_eq.toFixed(2)} mL`, eqX + 5, H - padding - 5);                ctx.beginPath();                ctx.arc(eqX, H - padding, 4, 0, 2 * Math.PI);                ctx.fill();                // --- ê·¸ë˜í”„ ìœ„ì— ì •ìˆ˜ë¹„ í‘œì‹œ (í•œê¸€) ---                const a = currentAcidValence;                const b = currentBaseValence;                                // ì •ìˆ˜ë¹„ ê³„ì‚° (N_initial : N_eq)                const I_initial_raw = b * (a + 1);                 const I_eq_raw = a + b;                           const commonDivisor = gcd(I_initial_raw, I_eq_raw);                const I_initial_simplified = I_initial_raw / commonDivisor;                const I_eq_simplified = I_eq_raw / commonDivisor;                const ratioString = `ì´ˆê¸° ì´ì˜¨ìˆ˜ : ì¤‘í™”ì ì—ì„œì˜ ì´ì˜¨ìˆ˜ = ${I_initial_simplified}:${I_eq_simplified}`;                                // Y ìœ„ì¹˜ ê³„ì‚°: ì¤‘í™”ì ì—ì„œì˜ ì´ ì´ì˜¨ ìˆ˜ ê°’                const N_eq_raw_value = calculateTotalIons(MA, VA, MB, V_eq, currentAcidValence, currentBaseValence);                const eqY = H - padding - N_eq_raw_value * yScale;                                ctx.font = '16px Inter bold';                ctx.fillStyle = '#10b981'; // Tailwind green-500                ctx.textAlign = 'center';                                // ì¤‘í™”ì  ê·¸ë˜í”„ ì„ ë³´ë‹¤ ì¡°ê¸ˆ ìœ„ì— ë¹„ìœ¨ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°                ctx.fillText(ratioString, eqX, eqY - 15);                                // í°íŠ¸ ë° ìƒ‰ìƒ ë³µì›                ctx.font = '14px Inter';                ctx.fillStyle = '#4b5563';            }            // --- ê·¸ë˜í”„ ë°ì´í„° ê·¸ë¦¬ê¸° (ì„ ) ---            ctx.beginPath();            ctx.strokeStyle = '#3b82f6'; // íŒŒë€ìƒ‰            ctx.lineWidth = 3;                        // ì²« ë²ˆì§¸ ì             const startX = padding + dataPoints[0].x * xScale;            const startY = H - padding - dataPoints[0].y * yScale;            ctx.moveTo(startX, startY);            // ë‚˜ë¨¸ì§€ ì ë“¤            dataPoints.forEach(point => {                const x = padding + point.x * xScale;                const y = H - padding - point.y * yScale;                ctx.lineTo(x, y);            });            ctx.stroke();            // --- ê²°ê³¼ ìš”ì•½ ì—…ë°ì´íŠ¸ ---            updateSummary(MA, VA, MB, VMaxGraph, V_eq, dataPoints);        }        // --- ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---        function updateSummary(MA, VA, MB, VMaxGraph, V_eq, dataPoints) {            const initialTotalIons = dataPoints[0].y.toFixed(2);            const finalTotalIons = dataPoints[dataPoints.length - 1].y.toFixed(2);            let eqIons = 0;            // ë“±ê°€ì  ì´ì˜¨ ìˆ˜ ì°¾ê¸°            if (V_eq >= 0 && V_eq <= VMaxGraph) { // VMaxGraph ì‚¬ìš©                eqIons = calculateTotalIons(MA, VA, MB, V_eq, currentAcidValence, currentBaseValence).toFixed(2);            }                        // --- ì´ˆê¸° ì´ ì´ì˜¨ ìˆ˜ì™€ ì¤‘í™”ì  ì´ ì´ì˜¨ ìˆ˜ì˜ ë¹„ ê³„ì‚° (ì •ìˆ˜ë¹„) ---            let integerRatioDisplay = 'N/A (ì¤‘í™”ì  ë¶€í”¼ ì´ˆê³¼)';                         if (V_eq >= 0 && V_eq <= VMaxGraph) { // VMaxGraph ì‚¬ìš©                const a = currentAcidValence;                const b = currentBaseValence;                // N_initialì˜ ìƒëŒ€ì ì¸ 'ë¶„ì' ê°’: b * (a + 1)                const I_initial_raw = b * (a + 1);                 // N_eqì˜ ìƒëŒ€ì ì¸ 'ë¶„ì' ê°’: a + b                const I_eq_raw = a + b;                                const commonDivisor = gcd(I_initial_raw, I_eq_raw);                const I_initial_simplified = I_initial_raw / commonDivisor;                const I_eq_simplified = I_eq_raw / commonDivisor;                integerRatioDisplay = `${I_initial_simplified} : ${I_eq_simplified}`;            }            // --- END NEW ---            resultsSummary.innerHTML = `                <h3 class="font-bold text-lg text-blue-700 mb-2">ê³„ì‚° ê²°ê³¼ ìš”ì•½</h3>                <ul class="list-disc list-inside space-y-1 text-gray-700">                    <li>ì„ íƒëœ ì¡°í•©: ${currentAcidValence}ê°€ ì‚° + ${currentBaseValence}ê°€ ì—¼ê¸°</li>                    <li>í”Œë¼ìŠ¤í¬ (ì‚°) ì´ˆê¸° ì´ì˜¨ ìˆ˜ (ìƒëŒ€ ëª°ìˆ˜): <span class="font-semibold">${initialTotalIons}</span></li>                    <li><span class="text-red-600 font-semibold">ì¤‘í™”ì  ë¶€í”¼ (V_eq): ${V_eq.toFixed(2)} mL</span></li>                    <li>ì¤‘í™”ì ì—ì„œì˜ ì´ ì´ì˜¨ ìˆ˜ (ìƒëŒ€ ëª°ìˆ˜): <span class="font-semibold">${eqIons}</span></li>                    <li><span class="text-indigo-600 font-semibold">ì´ˆê¸° ì´ì˜¨ìˆ˜ : ì¤‘í™”ì ì—ì„œì˜ ì´ì˜¨ìˆ˜ (ì •ìˆ˜ë¹„): ${integerRatioDisplay}</span></li>                    <!-- VMaxGraph ê°’ í‘œì‹œ -->                    <li><span class="text-gray-500">ì‹¤ì œ ê·¸ë˜í”„ ìµœëŒ€ ë¶€í”¼ (V_GraphMax): ${VMaxGraph.toFixed(2)} mL</span> ì—ì„œì˜ ì´ ì´ì˜¨ ìˆ˜ (ìƒëŒ€ ëª°ìˆ˜): <span class="font-semibold">${finalTotalIons}</span></li>                </ul>                <p class="mt-3 text-sm text-gray-600">                    ì°¸ê³ : ì´ ì´ì˜¨ ìˆ˜ ë³€í™”ì˜ 'ê¸°ìš¸ê¸°'ëŠ” ì‚°ê³¼ ì—¼ê¸°ì˜ ê°€ìˆ˜ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì¤‘í™”ì  ì „í›„ì˜ ê¸°ìš¸ê¸°ë¥¼ ë¹„êµí•´ ë³´ì„¸ìš”.                </p>            `;        }        // --- ì¡°í•© ì„ íƒ ë²„íŠ¼ ìƒì„± ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---        function setupCombinationSelectors() {            combinations.forEach((combo, index) => {                const button = document.createElement('button');                button.textContent = combo.name;                button.className = `combo-btn w-full p-3 rounded-lg font-semibold border-2 transition duration-150 ease-in-out`;                button.dataset.acid = combo.acidVal;                button.dataset.base = combo.baseVal;                button.dataset.index = index;                button.onclick = () => {                    selectCombination(combo.acidVal, combo.baseVal, index);                };                combinationSelectors.appendChild(button);            });            // ì´ˆê¸° ì„ íƒ            selectCombination(combinations[0].acidVal, combinations[0].baseVal, 0);        }        // --- ì¡°í•© ì„ íƒ ì²˜ë¦¬ ---        function selectCombination(acidVal, baseVal, index) {            currentAcidValence = acidVal;            currentBaseValence = baseVal;            // UI ì—…ë°ì´íŠ¸            acidValDisplay.textContent = `H${acidVal > 1 ? acidVal : ''}A`;            baseValDisplay.textContent = `B(OH)${baseVal > 1 ? baseVal : ''}`;                        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸            document.querySelectorAll('.combo-btn').forEach((btn, i) => {                if (i === index) {                    btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');                    btn.classList.add('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-md');                } else {                    btn.classList.add('bg-white', 'border-gray-300', 'text-gray-700');                    btn.classList.remove('bg-blue-600', 'border-blue-600', 'text-white', 'shadow-md');                }            });            // ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°            drawGraph();        }        // --- Firebase/Firestore Functions ---        async function submitRating() {            if (!isAuthReady || !db || selectedRating === 0) {                ratingMessage.textContent = "ì¸ì¦ ëŒ€ê¸° ì¤‘ì´ê±°ë‚˜ ë³„ì ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";                return;            }            // Get current parameters for context            const MA = parseFloat(inputs[0].value);            const VA = parseFloat(inputs[1].value);            const MB = parseFloat(inputs[2].value);                        const ratingData = {                userId: userId,                rating: selectedRating,                acidValence: currentAcidValence,                baseValence: currentBaseValence,                parameters: { MA, VA, MB },                timestamp: window.serverTimestamp()            };            try {                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';                const ratingsRef = window.collection(db, 'artifacts', appId, 'public', 'data', 'ratings');                await window.addDoc(ratingsRef, ratingData);                ratingMessage.textContent = `ë³„ì  ${selectedRating}ì  ì œì¶œ ì™„ë£Œ! ê°ì‚¬í•©ë‹ˆë‹¤.`;                submitRatingBtn.disabled = true; // Prevent re-submission immediately                setTimeout(() => { submitRatingBtn.disabled = false; }, 5000); // Re-enable after 5s            } catch (error) {                console.error("Error submitting rating: ", error);                ratingMessage.textContent = "ì œì¶œ ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";            }        }                // Firestoreì—ì„œ í›„ê¸° ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ ratings ë°°ì—´ ì—…ë°ì´íŠ¸        function setupRatingListener(db, appId) {            const ratingsRef = window.collection(db, 'artifacts', appId, 'public', 'data', 'ratings');            const q = window.query(ratingsRef);            // onSnapshotì€ ë°ì´í„° ë³€í™”ë¥¼ ê°ì§€í•˜ê³  ì½œë°± í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.            window.onSnapshot(q, (snapshot) => {                ratings = [];                snapshot.forEach((doc) => {                    ratings.push(doc.data());                });                drawAnalysisChart(ratings); // Fetch í›„ ë¶„ì„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸            }, (error) => {                console.error("Error listening to ratings:", error);                // ì—ëŸ¬ ë°œìƒ ì‹œ ê·¸ë˜í”„ ì´ˆê¸°í™” ë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ê°€ëŠ¥            });        }                // --- Bar Chart Visualization ---        function drawAnalysisChart(ratings) {            // Count ratings: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0}            const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };            ratings.forEach(r => {                const star = r.rating;                if (star >= 1 && star <= 5) {                    counts[star]++;                }            });                        const ratingData = Object.values(counts);            const maxCount = Math.max(...ratingData, 1); // 0ì¼ ê²½ìš° 1ë¡œ ì„¤ì •í•˜ì—¬ div by zero ë°©ì§€            const W = analysisCanvas.width;            const H = analysisCanvas.height;            const padding = 30;            const barWidth = (W - 2 * padding) / 5 - 10;            const chartHeight = H - 2 * padding;            actx.clearRect(0, 0, W, H);                        // X, Yì¶• ê·¸ë¦¬ê¸°            actx.beginPath();            actx.strokeStyle = '#374151';            actx.lineWidth = 1;            actx.moveTo(padding, padding);            actx.lineTo(padding, H - padding); // Y-axis            actx.lineTo(W - padding, H - padding); // X-axis            actx.stroke();            actx.fillStyle = '#1e40af'; // Darker blue for bars            actx.font = '12px Inter';            actx.textAlign = 'center';                        // Draw bars            ratingData.forEach((count, index) => {                const star = index + 1;                const barHeight = (count / maxCount) * chartHeight;                const x = padding + index * (barWidth + 10) + 5;                const y = H - padding - barHeight;                actx.fillRect(x, y, barWidth, barHeight);                // Draw label above bar                actx.fillStyle = '#111827'; // Dark gray for text                if (count > 0) {                    actx.fillText(count, x + barWidth / 2, y - 5);                }                // Draw star label below X-axis                actx.fillStyle = '#4b5563';                 actx.fillText(`${star}ì `, x + barWidth / 2, H - padding + 15);            });            // Y-axis label (Max count)            actx.fillStyle = '#4b5563';            actx.textAlign = 'right';            actx.fillText(maxCount, padding - 5, padding + 5);                        // Chart title            actx.font = '16px Inter bold';            actx.textAlign = 'center';            actx.fillStyle = '#111827';            actx.fillText('ì´ í›„ê¸° ë¶„í¬', W / 2, 20);        }        // --- Rating UI Setup ---        function setupRatingUI() {            // ë³„ ëª¨ì–‘ SVG ì•„ì´ì½˜            const starSvg = `<svg class="w-6 h-6 fill-current text-gray-300 transition duration-150 cursor-pointer hover:text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.49 6.91l6.572-.955L10 0l2.938 5.955 6.572.955-4.755 4.635 1.123 6.545z"/></svg>`;                        for (let i = 1; i <= 5; i++) {                const star = document.createElement('div');                star.innerHTML = starSvg;                star.dataset.rating = i;                star.classList.add('star');                                star.onmouseover = () => updateStarVisuals(i);                star.onmouseout = () => updateStarVisuals(selectedRating);                star.onclick = () => {                    selectedRating = i;                    updateStarVisuals(i);                    submitRatingBtn.disabled = false;                };                starRatingContainer.appendChild(star);            }            submitRatingBtn.onclick = submitRating;        }        // ë³„ì  ì‹œê°ì  ì—…ë°ì´íŠ¸ í•¨ìˆ˜        function updateStarVisuals(activeRating) {            document.querySelectorAll('.star').forEach(starEl => {                const starValue = parseInt(starEl.dataset.rating);                const svg = starEl.querySelector('svg');                if (starValue <= activeRating) {                    svg.classList.remove('text-gray-300');                    svg.classList.add('text-yellow-400');                } else {                    svg.classList.add('text-gray-300');                    svg.classList.remove('text-yellow-400');                }            });        }                // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---        async function init() {            // 1. Firebase Initialization & Auth            // ì „ì—­ ìŠ¤ì½”í”„ì— í• ë‹¹ëœ Firebase í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.            try {                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';                let firebaseConfig;                try {                    firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');                } catch (e) {                    console.error("Firebase config parsing error:", e);                    return;                }                const firebaseApp = window.initializeApp(firebaseConfig);                db = window.getFirestore(firebaseApp);                auth = window.getAuth(firebaseApp);                window.setLogLevel('Debug');                                 // Authentication                if (typeof __initial_auth_token !== 'undefined') {                    await window.signInWithCustomToken(auth, __initial_auth_token);                } else {                    await window.signInAnonymously(auth);                }                                userId = auth.currentUser?.uid || crypto.randomUUID();                isAuthReady = true;                                // 2. Start Rating Listener                setupRatingListener(db, appId);            } catch(e) {                console.error("Firebase initialization failed:", e);                // Fallback message if Firebase fails                ratingMessage.textContent = "DB ì—°ê²° ì‹¤íŒ¨. í›„ê¸° ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.";                submitRatingBtn.disabled = true;            }                        // 3. Setup UI & Listeners            // ìº”ë²„ìŠ¤ í¬ê¸° ë°˜ì‘í˜• ì„¤ì •            const setCanvasSize = () => {                // ì¤‘í™”ë°˜ì‘ ê·¸ë˜í”„                const container = ionCountCanvas.parentElement.parentElement; // div.card                ionCountCanvas.width = container.clientWidth - 48; // padding-6 (24*2) ì œì™¸                ionCountCanvas.height = ionCountCanvas.width * 0.75; // 4:3 ë¹„ìœ¨                                // ë¶„ì„ ê·¸ë˜í”„                const analysisContainer = analysisCanvas.parentElement.parentElement; // div.card                analysisCanvas.width = analysisContainer.clientWidth - 48;                analysisCanvas.height = analysisCanvas.width * 0.5; // 2:1 ë¹„ìœ¨                                drawGraph();                 if (isAuthReady) drawAnalysisChart(ratings); // ë°ì´í„°ê°€ ë¡œë“œëœ ê²½ìš° ë¶„ì„ ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°            };            window.addEventListener('resize', setCanvasSize);                        // ì…ë ¥ê°’ ë³€ê²½ ì‹œ ê·¸ë˜í”„ ìë™ ì—…ë°ì´íŠ¸            inputs.forEach(input => {                input.addEventListener('input', drawGraph);            });            // --- NEW: ë§ˆìš°ìŠ¤ íœ  ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì¶”ê°€ (ionCountCanvas) ---            const maxVolumeBaseInput = document.getElementById('maxVolumeBase');            ionCountCanvas.addEventListener('wheel', (event) => {                event.preventDefault(); // ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘ ë°©ì§€                let currentMaxVolume = parseFloat(maxVolumeBaseInput.value);                // ìœ íš¨ì„± ê²€ì‚¬ ë° ìµœì†Œê°’ ë³´ì¥                if (isNaN(currentMaxVolume) || currentMaxVolume <= 0) currentMaxVolume = 30;                 // Ctrl í‚¤ë¥¼ ëˆ„ë¥´ë©´ 5mL, ì•„ë‹ˆë©´ 2mLì”© ì¡°ì ˆí•˜ì—¬ ì¡°ì ˆ í­ ë³€ê²½                const zoomStep = event.ctrlKey ? 5 : 2;                 const minVolume = 10;                const maxVolume = 100; // ìµœëŒ€ ë¶€í”¼ ì œí•œ (ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒì„ ë°©ì§€)                let newMaxVolume;                if (event.deltaY < 0) {                    // ìŠ¤í¬ë¡¤ ì—…: Zoom In (ìµœëŒ€ ë¶€í”¼ ê°ì†Œ)                    newMaxVolume = currentMaxVolume - zoomStep;                } else if (event.deltaY > 0) {                    // ìŠ¤í¬ë¡¤ ë‹¤ìš´: Zoom Out (ìµœëŒ€ ë¶€í”¼ ì¦ê°€)                    newMaxVolume = currentMaxVolume + zoomStep;                } else {                    return;                }                                // ë²”ìœ„ ì œí•œ ì ìš© (ê°€ì¥ ê°€ê¹Œìš´ ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼)                newMaxVolume = Math.round(Math.min(maxVolume, Math.max(minVolume, newMaxVolume)));                // ê°’ì´ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì¬ê·¸ë¦¬ê¸° ë°©ì§€                if (newMaxVolume !== parseFloat(maxVolumeBaseInput.value)) {                    maxVolumeBaseInput.value = newMaxVolume;                    drawGraph(); // ê·¸ë˜í”„ ì¬ê·¸ë¦¬ê¸°                }            }, { passive: false });            setupCombinationSelectors(); // ì¡°í•© ì„ íƒ ë²„íŠ¼ ì´ˆê¸° ì„¤ì •            setupRatingUI(); // ë³„ì  UI ì„¤ì •            setCanvasSize(); // ì´ˆê¸° ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • ë° ê·¸ë˜í”„ ê·¸ë¦¬ê¸°        }        window.onload = init;    </script></body></html>